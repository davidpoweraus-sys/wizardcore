# Complete Stack Deployment Dockerfile
# Use this to deploy the entire WizardCore stack directly on a server
# This includes all services: frontend, backend, databases, auth, etc.

FROM alpine:latest as base

# Install necessary tools
RUN apk add --no-cache \
    docker \
    docker-compose \
    curl \
    bash \
    git \
    openssh-client \
    jq \
    && rm -rf /var/cache/apk/*

# Set working directory
WORKDIR /wizardcore

# Copy the entire project
COPY . .

# Create deployment script
RUN cat > /usr/local/bin/deploy-wizardcore << 'EOF'
#!/bin/bash
set -e

echo "ðŸš€ WizardCore Direct Deployment"
echo "================================"

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker is not running. Please start Docker daemon."
    exit 1
fi

# Set default values for environment variables
export DATABASE_PASSWORD=${DATABASE_PASSWORD:-wizardcore_password}
export SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET:-aNBMlTAljHvKyR2dPu6R6nyggeW2398Na3R4XL1+oyebUDiuzSO61nZzoVmRi0h4}
export REDIS_PASSWORD=${REDIS_PASSWORD:-xZDxSwVXHxVf6FYksaeEoA==}
export NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL:-https://offensivewizard.com/supabase-proxy}
export NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY:-uc8bo6Z4ZI4Fhu9XVgSz5LhDRWEQ0joGPMiZYroXPps=}
export NEXT_PUBLIC_JUDGE0_API_URL=${NEXT_PUBLIC_JUDGE0_API_URL:-https://judge0.offensivewizard.com}
export NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL:-https://offensivewizard.com/api}
export SUPABASE_INTERNAL_URL=${SUPABASE_INTERNAL_URL:-http://supabase-auth:9999}

# Create .env file for Docker Compose
cat > .env << ENV_EOF
# Database
DATABASE_PASSWORD=${DATABASE_PASSWORD}
POSTGRES_USER=wizardcore
POSTGRES_PASSWORD=${DATABASE_PASSWORD}
POSTGRES_DB=wizardcore

# Supabase Auth
SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
GOTRUE_API_EXTERNAL_URL=https://auth.offensivewizard.com
GOTRUE_CORS_ALLOWED_ORIGINS=https://offensivewizard.com
GOTRUE_DB_AUTOMIGRATE=true

# Frontend
NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
NEXT_PUBLIC_JUDGE0_API_URL=${NEXT_PUBLIC_JUDGE0_API_URL}
NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL}

# Backend
SUPABASE_INTERNAL_URL=${SUPABASE_INTERNAL_URL}
SUPABASE_URL=http://supabase-auth:9999
JUDGE0_API_URL=http://judge0:2358
REDIS_URL=redis:6379
REDIS_PASSWORD=${REDIS_PASSWORD}
CORS_ALLOWED_ORIGINS=https://offensivewizard.com
PORT=8080
ENVIRONMENT=production

# Judge0
JUDGE0_REDIS_PASSWORD=judge0
JUDGE0_POSTGRES_PASSWORD=judge0
ENV_EOF

echo "âœ… Environment variables configured"

# Pull latest images
echo "ðŸ“¥ Pulling Docker images..."
docker pull limpet/wizardcore-frontend:latest || echo "âš ï¸  Could not pull frontend image, will build from source"
docker pull limpet/wizardcore-backend:latest || echo "âš ï¸  Could not pull backend image, will build from source"
docker pull supabase/gotrue:v2.184.0
docker pull postgres:15-alpine
docker pull postgres:16-alpine
docker pull redis:7-alpine
docker pull redis:7.2-alpine
docker pull judge0/judge0:latest

# Build frontend if image not available
if ! docker image inspect limpet/wizardcore-frontend:latest > /dev/null 2>&1; then
    echo "ðŸ”¨ Building frontend from source..."
    docker build -f Dockerfile.nextjs -t limpet/wizardcore-frontend:latest .
fi

# Build backend if image not available
if ! docker image inspect limpet/wizardcore-backend:latest > /dev/null 2>&1; then
    echo "ðŸ”¨ Building backend from source..."
    docker build -f wizardcore-backend/Dockerfile -t limpet/wizardcore-backend:latest wizardcore-backend/
fi

# Stop and remove existing containers
echo "ðŸ”„ Stopping existing containers..."
docker-compose -f docker-compose.coolify.yml down --remove-orphans || true

# Start the stack
echo "ðŸš€ Starting WizardCore stack..."
docker-compose -f docker-compose.coolify.yml up -d --remove-orphans

# Wait for services to start
echo "â³ Waiting for services to be healthy..."
sleep 10

# Check service status
echo "ðŸ“Š Service Status:"
echo "-----------------"
docker-compose -f docker-compose.coolify.yml ps

# Test critical services
echo "ðŸ§ª Testing critical connections..."
if docker-compose -f docker-compose.coolify.yml exec -T postgres pg_isready -U wizardcore -d wizardcore; then
    echo "âœ… PostgreSQL is healthy"
else
    echo "âŒ PostgreSQL connection failed"
fi

echo ""
echo "ðŸŽ‰ Deployment complete!"
echo ""
echo "ðŸ“‹ Access URLs:"
echo "   Frontend: https://offensivewizard.com"
echo "   Backend API: https://offensivewizard.com/api"
echo "   Supabase Auth: https://offensivewizard.com/supabase-proxy"
echo ""
echo "ðŸ”§ Management commands:"
echo "   View logs: docker-compose -f docker-compose.coolify.yml logs -f"
echo "   Stop services: docker-compose -f docker-compose.coolify.yml down"
echo "   Restart services: docker-compose -f docker-compose.coolify.yml restart"
echo ""
EOF

RUN chmod +x /usr/local/bin/deploy-wizardcore

# Create health check script
RUN cat > /usr/local/bin/check-wizardcore << 'EOF'
#!/bin/bash
echo "ðŸ” WizardCore Health Check"
echo "=========================="

# Check if containers are running
if ! docker-compose -f /wizardcore/docker-compose.coolify.yml ps | grep -q "Up"; then
    echo "âŒ No services are running"
    exit 1
fi

echo "âœ… Services are running"
docker-compose -f /wizardcore/docker-compose.coolify.yml ps

echo ""
echo "ðŸŒ Testing endpoints..."
echo "----------------------"

# Test frontend
if curl -s -f https://offensivewizard.com > /dev/null; then
    echo "âœ… Frontend is accessible"
else
    echo "âŒ Frontend is not accessible"
fi

# Test backend
if curl -s -f https://offensivewizard.com/api/health > /dev/null; then
    echo "âœ… Backend API is accessible"
else
    echo "âŒ Backend API is not accessible"
fi

# Test PostgreSQL
if docker-compose -f /wizardcore/docker-compose.coolify.yml exec -T postgres pg_isready -U wizardcore -d wizardcore > /dev/null 2>&1; then
    echo "âœ… PostgreSQL is healthy"
else
    echo "âŒ PostgreSQL is not healthy"
fi

echo ""
echo "ðŸ“Š Resource usage:"
echo "-----------------"
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}" | head -10
EOF

RUN chmod +x /usr/local/bin/check-wizardcore

# Create update script
RUN cat > /usr/local/bin/update-wizardcore << 'EOF'
#!/bin/bash
set -e

echo "ðŸ”„ Updating WizardCore..."
echo "========================="

cd /wizardcore

# Pull latest changes
if [ -d .git ]; then
    echo "ðŸ“¥ Pulling latest code..."
    git pull origin main
else
    echo "âš ï¸  Not a git repository, skipping code update"
fi

# Pull latest images
echo "ðŸ“¥ Pulling latest Docker images..."
docker pull limpet/wizardcore-frontend:latest 2>/dev/null || true
docker pull limpet/wizardcore-backend:latest 2>/dev/null || true

# Restart services
echo "ðŸ”„ Restarting services..."
docker-compose -f docker-compose.coolify.yml down
docker-compose -f docker-compose.coolify.yml up -d

echo "âœ… Update complete!"
/usr/local/bin/check-wizardcore
EOF

RUN chmod +x /usr/local/bin/update-wizardcore

# Set entrypoint
ENTRYPOINT ["/usr/local/bin/deploy-wizardcore"]

# Metadata
LABEL maintainer="WizardCore Team"
LABEL version="1.0.0"
LABEL description="Complete WizardCore stack deployment container"